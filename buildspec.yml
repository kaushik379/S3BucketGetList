version: 0.2

env:
  variables:
    IMAGE_NAME: demoimages
    REGION: us-east-1

phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR
      - |
        # Function to login and tag/push
        push_to_ecr() {
          ACCOUNT_ID=$1
          ROLE_ARN="arn:aws:iam::$ACCOUNT_ID:role/ECRPushRole"
          CREDS=$(aws sts assume-role --role-arn $ROLE_ARN --role-session-name "ecrpushsession")
          export AWS_ACCESS_KEY_ID=$(echo $CREDS | jq -r '.Credentials.AccessKeyId')
          export AWS_SECRET_ACCESS_KEY=$(echo $CREDS | jq -r '.Credentials.SecretAccessKey')
          export AWS_SESSION_TOKEN=$(echo $CREDS | jq -r '.Credentials.SessionToken')

          aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com
          docker tag $IMAGE_NAME:latest $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/$IMAGE_NAME:latest
          docker push $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/$IMAGE_NAME:latest
        }

  build:
    commands:
      - echo Build started on `date`
      - docker build -t $IMAGE_NAME .

  post_build:
    commands:
      - echo Build completed on `date`
      - push_to_ecr 861530259719
      # - push_to_ecr <other-account-id>
